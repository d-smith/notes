# Cloud HSM Deep Dive

## Cloud HSM

Review overview and diffs between KMS and Cloud HSM - see part 4 notes.

Create a cluster and HSM:

* create vpc
* create a private and public subnet
* create the cluster
* verify the hsm identity
* initialize the cluster
* launch a client instance
* install and configure the client
* activate the cluster
* setup users
* generate keys

HSM cluster

* create a cluster in a vpc, put in private subnets in at least two availability zones
* after cluster created, initialize the cluster
    * pick an AZ, create
    * download cluster csr, hsm certificate, aws certificate, manufacturer certificate
    * learn more > how to get the root certificates (aws and manufacturer), download and verify

## Cloud HSM - Verifying Our Certs

To initialize your cluster, you sign a certificate signing request (CSR) generated by the cluster's first HSM.

Process documented [here](https://docs.aws.amazon.com/cloudhsm/latest/userguide/verify-hsm-identity.html)

Sign the cluster CSR to initialize the cluster.

## AWS CloudHSM - Initializing Our Cluster

Steps:

* Get the cluster CSR
* Sign the CSR
* Initialize the cluster

Once the cluster is initialized, you manage it via an EC2 instance.

## CloudHSM - Installing and Configuring Our Client

Use an EC2 instance in the private subnet.

* Download and install the software
* Grab the cert used to initialize the cluster
* Configure the client

## CloudHSM - Activating Our Cluster

Activate the cluster using the client software we installed.

Cloud HSM Users - see [here](https://docs.aws.amazon.com/cloudhsm/latest/userguide/hsm-users.html)

* Precrypto Officer (PRECO)
    * Default administrator when we provision our HSM, removed later
* Crypto Officer (PCO and CO)
    * First user, can generate other crypto officers
* Crypto Users (CU)
* Appliance User (AU)

Roles

* Crypto Officer (PCO and CO)
  * Performs user management operations - create and delete users, change user passwords.
  * Can't do anything with keys
* Crypto Users (CU)
  * Key management - create, delete, chare, import, and export crytographic keys
  * Crytographic operations - use keys for encryption, decryption, signing, verifying, and more.
* Appliance User
  * Perform cloning and sync operations.
  * Exists on all HSMs provided by AWS CloudHSM and has limited permissions.


Client - cloudhsm_mgmt_util

* enable_e2e - enable end to end encryption
* listUsers
* loginHSM PRECO admin password 
  * Login as PRECO using default creds - `loginHSM PRECO admin password`
  * CHange PRECO password - PRECO is now a crypto officer - `changePswd PRECO admin <NewPassword>`
* create CO and CU users
  * `createUser <user type> <user name> <password>`

Key Management Utility

* start cloudhsm-client
* /opt/cloudhsm/bin/key_mgmt_util
* loginHSM -u CU -p password -s username

## CloudHSM - Generating and Exporting Our Keys


